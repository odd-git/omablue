#!/bin/bash

# --- Secureblue Header ---
# Ensure path consistency for Homebrew and local Omablue scripts
export PATH="/home/linuxbrew/.linuxbrew/bin:$HOME/.local/share/omablue/bin:$HOME/.local/bin:/usr/local/bin:/usr/bin:/bin:$PATH"

# Setup save directory
SAVE_DIR="$HOME/Pictures/Screenshots"
mkdir -p "$SAVE_DIR"
TIMESTAMP=$(date +'%Y-%m-%d-%H%M%S')
FILE_PATH="$SAVE_DIR/screenshot_$TIMESTAMP.png"

# 1. Interactive menu using gum
# We capture the choice but also check the exit code of the command
CHOICE=$(gum choose --header "What do you want to capture?" "Select Area" "Active Window" "Fullscreen" "Cancel")

# 2. Check if the user pressed ESC or interrupted the process
# Gum returns a non-zero exit code (usually 130 for Ctrl+C or 1 for Esc)
if [ $? -ne 0 ]; then
  echo "Capture cancelled by user."
  exit 0
fi

case $CHOICE in
"Select Area")
  # Using Sway logic to clear the view for selection
  swaymsg [title="omablue-screenshot"] move scratchpad
  sleep 0.2
  GEOMETRY=$(slurp)
  ;;
"Active Window")
  swaymsg [title="omablue-screenshot"] move scratchpad
  sleep 0.2
  # Logic to target the focused container in the Wayland tree
  GEOMETRY=$(swaymsg -t get_tree | jq -r '.. | select(.focused? == true).rect | "\(.x),\(.y) \(.width)x\(.height)"')
  ;;
"Fullscreen")
  swaymsg [title="omablue-screenshot"] move scratchpad
  sleep 0.2
  GEOMETRY=""
  ;;
"Cancel" | *)
  exit 0
  ;;
esac

# 3. Validation before execution
# If slurp was cancelled (Esc during area selection), GEOMETRY might be empty
if [ "$CHOICE" == "Select Area" ] && [ -z "$GEOMETRY" ]; then
  notify-send -u low "Omablue" "Area selection cancelled"
  exit 0
fi

# Execute capture using grim (Native Wayland)
if [ -z "$GEOMETRY" ]; then
  grim "$FILE_PATH"
else
  grim -g "$GEOMETRY" "$FILE_PATH"
fi

# 4. Notify and copy to clipboard using Wayland protocols
if [ -f "$FILE_PATH" ]; then
  wl-copy <"$FILE_PATH"
  # Functional aesthetic: Notification with icon
  notify-send "Omablue Screenshot" "Saved to $SAVE_DIR and copied to clipboard" -i camera-photo
fi
