#!/bin/bash

# --- Omablue Theme Generator ---
# Parses colors.toml and generates configs for all applications
# Usage: omablue-theme-generate <theme-path> <output-dir>

set -e

THEME_PATH="${1:-}"
OUTPUT_DIR="${2:-}"

if [[ -z "$THEME_PATH" || -z "$OUTPUT_DIR" ]]; then
  echo "Usage: omablue-theme-generate <theme-path> <output-dir>"
  echo "Example: omablue-theme-generate ~/.local/share/omablue/themes/catppuccin ~/.config/omablue/current"
  exit 1
fi

COLORS_FILE="$THEME_PATH/colors.toml"

if [[ ! -f "$COLORS_FILE" ]]; then
  echo "Error: colors.toml not found in $THEME_PATH"
  exit 1
fi

mkdir -p "$OUTPUT_DIR"

# --- Parse colors.toml ---
# Simple TOML parser for key = "value" format
declare -A COLORS

while IFS='=' read -r key value; do
  # Skip empty lines and comments
  [[ -z "$key" || "$key" =~ ^[[:space:]]*# ]] && continue

  # Clean up key and value
  key=$(echo "$key" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
  value=$(echo "$value" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr -d '"')

  [[ -n "$key" && -n "$value" ]] && COLORS["$key"]="$value"
done < "$COLORS_FILE"

# Helper function to get color with fallback
get_color() {
  local key="$1"
  local fallback="$2"
  echo "${COLORS[$key]:-$fallback}"
}

# Helper function to get color without # prefix (for foot)
get_color_no_hash() {
  local key="$1"
  local fallback="$2"
  local color="${COLORS[$key]:-$fallback}"
  echo "${color#\#}"  # Strip leading # if present
}

# --- Generate Sway Theme ---
generate_sway_theme() {
  local out="$OUTPUT_DIR/sway-theme.txt"

  cat > "$out" << EOF
# Sway theme - generated by omablue-theme-generate
# Do not edit manually - changes will be overwritten

set \$base $(get_color background "#1e1e2e")
set \$text $(get_color foreground "#cdd6f4")
set \$surface0 $(get_color color0 "#45475a")
set \$overlay0 $(get_color color8 "#585b70")

set \$blue $(get_color color4 "#89b4fa")
set \$lavender $(get_color accent "#89b4fa")
set \$rosewater $(get_color cursor "#f5e0dc")
set \$peach $(get_color color3 "#f9e2af")
set \$red $(get_color color1 "#f38ba8")
set \$green $(get_color color2 "#a6e3a1")
set \$yellow $(get_color color3 "#f9e2af")
set \$mauve $(get_color color5 "#f5c2e7")
set \$teal $(get_color color6 "#94e2d5")
EOF

  echo "Generated: $out"
}

# --- Generate Waybar Colors ---
generate_waybar_theme() {
  local out="$OUTPUT_DIR/waybar-colors.css"

  cat > "$out" << EOF
/* Waybar colors - generated by omablue-theme-generate */
/* Do not edit manually - changes will be overwritten */

@define-color background $(get_color background "#1e1e2e");
@define-color foreground $(get_color foreground "#cdd6f4");
@define-color accent $(get_color accent "#89b4fa");
@define-color selection $(get_color selection_background "#f5e0dc");

@define-color red $(get_color color1 "#f38ba8");
@define-color green $(get_color color2 "#a6e3a1");
@define-color yellow $(get_color color3 "#f9e2af");
@define-color blue $(get_color color4 "#89b4fa");
@define-color magenta $(get_color color5 "#f5c2e7");
@define-color cyan $(get_color color6 "#94e2d5");
EOF

  echo "Generated: $out"
}

# --- Generate Foot Theme ---
generate_foot_theme() {
  local out="$OUTPUT_DIR/foot-theme.ini"

  cat > "$out" << EOF
# Foot terminal theme - generated by omablue-theme-generate
# Do not edit manually - changes will be overwritten
# Include this in your foot.ini: include=~/.config/omablue/current/foot-theme.ini

[colors]
cursor=$(get_color_no_hash cursor "f5e0dc") $(get_color_no_hash background "1e1e2e")
foreground=$(get_color_no_hash foreground "cdd6f4")
background=$(get_color_no_hash background "1e1e2e")

selection-foreground=$(get_color_no_hash selection_foreground "1e1e2e")
selection-background=$(get_color_no_hash selection_background "f5e0dc")

# Normal colors
regular0=$(get_color_no_hash color0 "45475a")
regular1=$(get_color_no_hash color1 "f38ba8")
regular2=$(get_color_no_hash color2 "a6e3a1")
regular3=$(get_color_no_hash color3 "f9e2af")
regular4=$(get_color_no_hash color4 "89b4fa")
regular5=$(get_color_no_hash color5 "f5c2e7")
regular6=$(get_color_no_hash color6 "94e2d5")
regular7=$(get_color_no_hash color7 "bac2de")

# Bright colors
bright0=$(get_color_no_hash color8 "585b70")
bright1=$(get_color_no_hash color9 "f38ba8")
bright2=$(get_color_no_hash color10 "a6e3a1")
bright3=$(get_color_no_hash color11 "f9e2af")
bright4=$(get_color_no_hash color12 "89b4fa")
bright5=$(get_color_no_hash color13 "f5c2e7")
bright6=$(get_color_no_hash color14 "94e2d5")
bright7=$(get_color_no_hash color15 "a6adc8")
EOF

  echo "Generated: $out"
}

# --- Generate Rofi Colors ---
generate_rofi_theme() {
  local out="$OUTPUT_DIR/rofi-colors.rasi"

  cat > "$out" << EOF
/* Rofi colors - generated by omablue-theme-generate */
/* Do not edit manually - changes will be overwritten */

* {
    bg-col: $(get_color background "#1e1e2e");
    border-col: $(get_color accent "#89b4fa");
    selected-col: $(get_color color0 "#45475a");
    text-col: $(get_color foreground "#cdd6f4");
    selected-text: $(get_color color5 "#f5c2e7");
    urgent-col: $(get_color color1 "#f38ba8");
    active-col: $(get_color color2 "#a6e3a1");
}
EOF

  echo "Generated: $out"
}

# --- Generate Dunst Theme ---
generate_dunst_theme() {
  local out="$OUTPUT_DIR/dunst-theme.conf"

  local bg=$(get_color background "#1e1e2e")
  local fg=$(get_color foreground "#cdd6f4")
  local accent=$(get_color accent "#89b4fa")
  local red=$(get_color color1 "#f38ba8")
  local yellow=$(get_color color3 "#f9e2af")

  cat > "$out" << EOF
# Dunst theme - generated by omablue-theme-generate
# Do not edit manually - changes will be overwritten

[urgency_low]
    background = "$bg"
    foreground = "$fg"
    frame_color = "$accent"
    timeout = 5

[urgency_normal]
    background = "$bg"
    foreground = "$fg"
    frame_color = "$accent"
    timeout = 10

[urgency_critical]
    background = "$bg"
    foreground = "$red"
    frame_color = "$red"
    timeout = 0
EOF

  echo "Generated: $out"
}

# --- Main ---
echo "Generating theme files from: $COLORS_FILE"
echo "Output directory: $OUTPUT_DIR"
echo ""

generate_sway_theme
generate_waybar_theme
generate_foot_theme
generate_rofi_theme
generate_dunst_theme

echo ""
echo "Theme generation complete!"
