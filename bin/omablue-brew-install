#!/bin/bash

# Forza il path per trovare eventuali utility locali
export PATH="$HOME/.local/share/omablue/bin:$PATH"

# Check if fzf is installed
if ! command -v fzf &> /dev/null; then
    echo "Error: fzf is not installed."
    exit 1
fi

# Check if brew is installed
if ! command -v brew &> /dev/null; then
    echo "Error: Homebrew (brew) non Ã¨ installato."
    exit 1
fi

echo "Caricamento lista pacchetti Homebrew (Formulae & Casks)..."

# Recuperiamo sia i pacchetti CLI che le App GUI
# Aggiungiamo un'etichetta per distinguerli nel menu
LIST=$( (brew formulae | awk '{print $1 " [formula]"}'; brew casks | awk '{print $1 " [cask]"}') )

if [[ -z "$LIST" ]]; then
    echo "Errore nel recupero della lista Brew."
    exit 1
fi

# Selezione tramite fzf
SELECTED=$(echo "$LIST" | fzf \
    --header='Seleziona un pacchetto Homebrew da installare' \
    --prompt='Search Brew > ' \
    --layout=reverse \
    --height=80% \
    --border)

# Se l'utente preme ESC o non seleziona nulla
if [[ -z "$SELECTED" ]]; then
    echo "Operazione annullata."
    exit 0
fi

# Estraiamo solo il nome del pacchetto (rimuovendo l'etichetta [formula] o [cask])
PACKAGE=$(echo "$SELECTED" | awk '{print $1}')

# Processo di installazione
clear
echo -e "Installazione di: \e[33m$PACKAGE\e[0m\n"

if brew install "$PACKAGE"; then
    notify-send "Omarchy" "Installazione completata: $PACKAGE"
    echo -e "\n\e[32mOperazione conclusa.\e[0m"
else
    echo -e "\n\e[31mErrore durante l'installazione di $PACKAGE.\e[0m"
fi
