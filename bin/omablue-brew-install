#!/bin/bash

# --- Secureblue Header ---
PATH="/usr/bin:/usr/local/bin:$PATH"

# 1. Dependency Check
if ! command -v fzf &>/dev/null; then
  notify-send -u critical "Error" "fzf is required."
  exit 1
fi

# 2. Remote Auto-Detection
# Cerca flathub, altrimenti usa il primo disponibile
TARGET_REMOTE=$(flatpak remotes --columns=name | grep -i "flathub" | head -n 1)

if [ -z "$TARGET_REMOTE" ]; then
  TARGET_REMOTE=$(flatpak remotes --columns=name | head -n 1)
fi

if [ -z "$TARGET_REMOTE" ]; then
  notify-send -u critical "Flatpak Error" "Nessun remote configurato."
  exit 1
fi

notify-send -u low -i "system-search" "Flatpak Browser" "Fetching list from: $TARGET_REMOTE..."

# 3. Fetching & Formatting Data
# Recuperiamo: Name, ID, Version.
# Usiamo awk per creare una tabella visiva pulita con separatore '|'
# %-30s = Colonna Nome larga 30 caratteri (allineata a sinistra)
# %-40s = Colonna ID larga 40 caratteri
# Questo assicura che l'ID sia ben visibile e allineato.
formatted_list=$(flatpak remote-ls "$TARGET_REMOTE" --app --columns=name,application,version |
  awk -F'\t' '{printf "%-30s | %-40s | %s\n", $1, $2, $3}')

# 4. Interactive Selection (Omarchy Style)
# --height 100%: Occupa tutta la finestra disponibile
# --header: Intestazione della tabella
# -d '|': Dice a fzf che il separatore per la ricerca Ã¨ il pipe (opzionale, estetico qui)
selected_line=$(echo "$formatted_list" | fzf \
  --prompt="Install from $TARGET_REMOTE > " \
  --header="NAME                           | ID                                       | VERSION" \
  --layout=reverse \
  --height=100% \
  --border \
  --ansi)

# Exit se l'utente annulla (ESC)
if [ -z "$selected_line" ]; then
  exit 0
fi

# 5. ID Extraction
# Estraiamo la seconda colonna (l'ID) usando il separatore '|'
# 'tr -d " "' rimuove gli spazi di padding aggiunti per l'allineamento
app_id=$(echo "$selected_line" | awk -F '|' '{print $2}' | tr -d ' ')

# 6. Installation
clear
echo "Inizializzazione installazione atomica per: $app_id"
echo "Remote: $TARGET_REMOTE"
echo "-----------------------------------------------------"

# Installazione silenziosa per runtimes, ma esplicita per l'app
flatpak install --noninteractive -y "$TARGET_REMOTE" "$app_id"

# Check finale
if [ $? -eq 0 ]; then
  notify-send -u normal -i "software-installed" "Success" "$app_id installato correttamente."
else
  notify-send -u critical -i "dialog-error" "Failed" "Errore durante l'installazione di $app_id."
fi
