#!/bin/bash

# Force path for local utilities
export PATH="$HOME/.local/share/omablue/bin:$PATH"

# Check dependencies
if ! command -v fzf &>/dev/null; then
  echo "Error: fzf is not installed."
  read -p "Press Enter to exit..."
  exit 1
fi

if ! command -v brew &>/dev/null; then
  echo "Error: Homebrew is not installed."
  read -p "Press Enter to exit..."
  exit 1
fi

echo "Fetching Homebrew packages (Formulae & Casks)..."

# Combine formulae and casks for selection
LIST=$( (
  brew formulae | awk '{print $1 " [formula]"}'
  brew casks | awk '{print $1 " [cask]"}'
))

if [[ -z "$LIST" ]]; then
  echo "Error retrieving Brew list."
  read -p "Press Enter to exit..."
  exit 1
fi

# Selection via fzf
SELECTED=$(echo "$LIST" | fzf \
  --header='Select Homebrew package to install' \
  --prompt='Search Brew > ' \
  --layout=reverse \
  --height=80% \
  --border)

if [[ -z "$SELECTED" ]]; then
  echo "Operation cancelled."
  sleep 1
  exit 0
fi

# Extract package name
PACKAGE=$(echo "$SELECTED" | awk '{print $1}')

clear
echo -e "Installing: \e[33m$PACKAGE\e[0m\n"

# Installation process with persistence logic
if brew install "$PACKAGE"; then
  # Send notification to Dunst
  notify-send -a "Omablue" -i "package-x-generic" "Install Success" "Package: $PACKAGE"
  echo -e "\n\e[32mInstallation finished successfully.\e[0m"
else
  notify-send -u critical -a "Omablue" "Install Failed" "Error during $PACKAGE installation"
  echo -e "\n\e[31mError occurred during installation of $PACKAGE.\e[0m"
fi

# Force terminal to stay open until user action
echo -e "\n---"
read -p "Press [Enter] to close this window..."
