#!/bin/bash

# Force path for gum if needed (consistent with your other scripts)
export PATH="$HOME/.local/share/omablue/bin:$PATH"

# Check if gum is installed
if ! command -v gum &>/dev/null; then
  echo "Error: gum is not installed."
  exit 1
fi

# 1. Fetch installed Flatpaks
# We format it as "Name | ApplicationID" for the picker
MAP_LIST=$(flatpak list --columns=name,application | sed 's/\t/ | /')

if [[ -z "$MAP_LIST" ]]; then
  echo "Nessuna app Flatpak trovata."
  notify-send "Omarchy" "Nessuna app Flatpak installata."
  exit 0
fi

# 2. Selection via Gum
# --no-limit allows multiple selection
SELECTED=$(echo "$MAP_LIST" | gum choose \
  --no-limit \
  --header "Seleziona le app Flatpak da rimuovere (Spazio per selezionare, Invio per confermare)" \
  --selected-prefix="[X] " \
  --unselected-prefix="[ ] " \
  --cursor-prefix="> ")

# Exit if nothing was selected
if [[ -z "$SELECTED" ]]; then
  echo "Operazione annullata."
  exit 0
fi

# 3. Process Removal
# Extract only the Application ID (the part after the '|')
APP_IDS=$(echo "$SELECTED" | awk -F ' | ' '{print $NF}')

for ID in $APP_IDS; do
  echo -e "\nRimoziome di: \e[33m$ID\e[0m..."

  # -y for non-interactive removal since we already chose in gum
  if flatpak uninstall -y "$ID"; then
    notify-send "Omarchy" "Rimosso: $ID"
  else
    echo "Errore durante la rimozione di $ID"
  fi
done

echo -e "\n\e[32mOperazione conclusa.\e[0m"
