#!/bin/bash

# Omablue: The Secureblue Theme Engine
# Architecture: Atomic / Sway / Ghostty / Dunst

# Check for required theme argument; exit if missing or set to "CNCLD"
if [[ -z $1 && $1 != "CNCLD" ]]; then
  echo "Usage: omablue-theme-set <theme-name>"
  exit 1
fi

# Define paths for theme storage and the active symlink
THEMES_DIR="$HOME/.local/share/omablue/themes"
CURRENT_THEME_LINK="$HOME/.config/ombalue/current/theme"

# Normalize theme name: strip tags, convert to lowercase, and replace spaces with hyphens
THEME_NAME=$(echo "$1" | sed -E 's/<[^>]+>//g' | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
THEME_PATH="$THEMES_DIR/$THEME_NAME"

# Verify that the requested theme directory exists
if [[ ! -d "$THEME_PATH" ]]; then
  echo "❌ Theme '$THEME_NAME' not found in $THEMES_DIR"
  exit 1
fi

# --- 1. Update Theme Symlink (Atomic Workflow) ---
# Update the master symlink to point to the new theme directory
ln -nsf "$THEME_PATH" "$CURRENT_THEME_LINK"

# --- 2. Ghostty Terminal Configuration ---
# Link the theme's Ghostty config to the active terminal profile
if [[ -f "$THEME_PATH/ghostty.conf" ]]; then
  ln -nsf "$THEME_PATH/ghostty.conf" "$HOME/.config/ghostty/theme_current"
  # Signal Ghostty to live-reload configuration without closing active windows
  pkill -USR1 ghostty
fi

# --- 3. Dunst Notification Management (Atomic Fusion Strategy) ---
# Define Dunst configuration paths
DUNST_BASE="$HOME/.config/dunst/dunstrc.base"
DUNST_TARGET="$HOME/.config/dunst/dunstrc"
THEME_DUNST="$THEME_PATH/dunst.conf"

if [[ -f "$DUNST_BASE" && -f "$THEME_DUNST" ]]; then
  echo "⚙️  Regenerating Dunst configuration..."

  # FUSION: Concatenate the global base config with the theme-specific overrides
  cat "$DUNST_BASE" "$THEME_DUNST" >"$DUNST_TARGET"

  # Clean Restart: Terminate Dunst and allow DBus to restart it with new config
  killall dunst 2>/dev/null

  # Brief pause to ensure the process has exited
  sleep 0.5

  # Send notification to verify the new notification style is active
  notify-send -h string:x-dunst-stack-tag:
