#!/bin/bash

# --- Secureblue Header ---
PATH="/usr/bin:/usr/local/bin:$PATH"

# 1. Dependency Check
if ! command -v fzf &>/dev/null; then
  notify-send -u critical "Error" "fzf is required."
  exit 1
fi

# 2. Remote Auto-Detection

TARGET_REMOTE=$(flatpak remotes --columns=name | grep -i "flathub" | head -n 1)

if [ -z "$TARGET_REMOTE" ]; then
  TARGET_REMOTE=$(flatpak remotes --columns=name | head -n 1)
fi

if [ -z "$TARGET_REMOTE" ]; then
  notify-send -u critical "Flatpak Error" "Nessun remote configurato."
  exit 1
fi

notify-send -u low -i "system-search" "Flatpak Browser" "Fetching list from: $TARGET_REMOTE..."

# 3. Fetching & Formatting Data
formatted_list=$(flatpak remote-ls "$TARGET_REMOTE" --app --columns=name,application,version |
  awk -F'\t' '{printf "%-30s | %-40s | %s\n", $1, $2, $3}')

# 4. Interactive Selection (Omarchy Style)
selected_line=$(echo "$formatted_list" | fzf \
  --prompt="Install from $TARGET_REMOTE > " \
  --header="NAME                           | ID                                       | VERSION" \
  --layout=reverse \
  --height=100% \
  --border \
  --ansi)

# Exit (ESC)
if [ -z "$selected_line" ]; then
  exit 0
fi

# 5. ID Extraction
app_id=$(echo "$selected_line" | awk -F '|' '{print $2}' | tr -d ' ')

# 6. Installation
clear
echo "Installation of  $app_id"
echo "Remote: $TARGET_REMOTE"
echo "-----------------------------------------------------"

flatpak install --noninteractive -y "$TARGET_REMOTE" "$app_id"

if [ $? -eq 0 ]; then
  notify-send -u normal -i "software-installed" "Success" "$app_id installed properly."
else
  notify-send -u critical -i "dialog-error" "Failed" " Error during installation of  $app_id."
fi
