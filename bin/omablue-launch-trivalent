#!/bin/bash

# --- 1. Global Environment & Path ---
# Injecting paths to ensure jq and rofi are found [cite: 1, 2]
export PATH="$HOME/.local/bin:$HOME/.local/share/omablue/bin:/usr/local/bin:/usr/bin:/bin:$PATH"
CONFIG_DIR="$HOME/.config/trivalent"
LOCAL_STATE="$CONFIG_DIR/Local State"

# --- 2. Dependencies Check ---
if ! command -v jq &>/dev/null; then
  notify-send "Error" "jq is required to parse browser profiles." [cite: 21, 69]
  exit 1
fi

# --- 3. Profile Discovery ---
# Extracting folder|name pairs from Local State
if [[ -f "$LOCAL_STATE" ]]; then
  PROFILE_DATA=$(jq -r '.profile.info_cache | to_entries[] | "\(.value.name)|\(.key)"' "$LOCAL_STATE" 2>/dev/null)
else
  notify-send "Error" "Trivalent Local State not found at $CONFIG_DIR"
  exit 1
fi

if [[ -z "$PROFILE_DATA" ]]; then
  notify-send "Trivalent" "No profiles detected."
  exit 1
fi

# --- 4. User Selection (Rofi) ---
# We display only the 'name' (first field) to the user [cite: 7, 16]
SELECTED_NAME=$(echo "$PROFILE_DATA" | cut -d'|' -f1 | rofi -dmenu -i -p "ó°–Ÿ Trivalent Profile" -theme my_theme.rasi)

[[ -z "$SELECTED_NAME" ]] && exit 0

# --- 5. Launch ---
# Retrieve the folder name (second field) corresponding to the selected name
PROFILE_DIR=$(echo "$PROFILE_DATA" | grep "^$SELECTED_NAME|" | cut -d'|' -f2 | head -n 1)

if [[ -n "$PROFILE_DIR" ]]; then
  # Launching without an attached terminal [cite: 18]
  nohup trivalent --profile-directory="$PROFILE_DIR" >/dev/null 2>&1 &
  disown [cite: 18]
else
  notify-send "Error" "Could not resolve profile directory for $SELECTED_NAME"
fi
