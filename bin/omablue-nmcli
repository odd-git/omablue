#!/usr/bin/env bash

# --- Secureblue Sway Architect: Network Manager ---

CONFIG_DIR="$HOME/.config/sway-network"
mkdir -p "$CONFIG_DIR"
PASS_FILE="$CONFIG_DIR/hotspot_pass"
INTERFACE=$(nmcli -t -f DEVICE,TYPE device | grep wifi | cut -d: -f1 | head -n1)

toggle_wifi() {
  STATE=$(nmcli radio wifi)
  if [ "$STATE" = "enabled" ]; then
    nmcli device disconnect "$INTERFACE"
    nmcli radio wifi off
    notify-send -a "Network" -i network-wireless-off-symbolic "WiFi: DISABLED"
  else
    nmcli radio wifi on
    notify-send -a "Network" -i network-wireless-symbolic "WiFi: ENABLED"
  fi
}

manage_hotspot() {
  HOTSPOT_OPTIONS="󰖩 Toggle Hotspot\n󰒄 Set/Change Password"
  SEL=$(echo -e "$HOTSPOT_OPTIONS" | rofi -dmenu -p "Hotspot Settings" -i -width 20)

  case "$SEL" in
  *"Toggle Hotspot")
    IS_ACTIVE=$(nmcli -t -f CONNECTION device show "$INTERFACE" | grep "Hotspot")
    if [ -n "$IS_ACTIVE" ]; then
      nmcli con down Hotspot && notify-send -a "Network" "Hotspot: DEACTIVATED"
    else
      [ ! -f "$PASS_FILE" ] && rofi -dmenu -p "No password set. Enter new:" -password >"$PASS_FILE"
      HPASS=$(cat "$PASS_FILE")
      nmcli device wifi hotspot ssid "$(hostname)" password "$HPASS" &&
        notify-send -a "Network" -i folder-remote "Hotspot: ACTIVATED (SSID: $(hostname))"
    fi
    ;;
  *"Set/Change Password")
    NEW_PASS=$(rofi -dmenu -p "New Hotspot Password (min 8 chars)" -password -lines 0)
    if [ ${#NEW_PASS} -ge 8 ]; then
      echo "$NEW_PASS" >"$PASS_FILE"
      notify-send -a "Network" "Hotspot password updated successfully"
    else
      notify-send -u critical "Error" "Password must be at least 8 characters"
    fi
    ;;
  esac
}

# Main Menu
MAIN_OPTIONS="󰖩 Connect\n󰖪 Disconnect\n󰀞 Toggle WiFi\n󱚹 Hotspot Manager"
CHOSEN=$(echo -e "$MAIN_OPTIONS" | rofi -dmenu -p "Network Menu" -i -width 25)

case "$CHOSEN" in
*Connect)
  WIFI_LIST=$(nmcli --terse --fields "SSID,BARS,SECURITY" device wifi list | awk -F: '$1 != "" {print $1 " | " $2 " | " $3}' | sort -u -t'|' -k1,1)
  CHOSEN_SSID_LINE=$(echo -e "$WIFI_LIST" | rofi -dmenu -p "Select SSID" -i)
  [ -z "$CHOSEN_SSID_LINE" ] && exit 0
  SSID=$(echo "$CHOSEN_SSID_LINE" | cut -d'|' -f1 | xargs)
  nmcli device wifi connect "$SSID" || {
    PASS=$(rofi -dmenu -p "Password for $SSID" -password -lines 0)
    nmcli device wifi connect "$SSID" password "$PASS"
  }
  ;;
*Disconnect)
  nmcli device disconnect "$INTERFACE" && notify-send -a "Network" "Disconnected"
  ;;
*Toggle*)
  toggle_wifi
  ;;
*Hotspot*)
  manage_hotspot
  ;;
esac
