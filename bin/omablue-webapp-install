#!/bin/bash
# 1. Forza il titolo della finestra per le regole di Sway (Floating Center)


# 2. PATH Setup Robusto (per trovare gum e jq ovunque)

export PATH="$HOME/.local/share/omablue/bin:$HOME/.local/bin:/usr/local/bin:/usr/bin:/bin:$PATH"
OMABIN="$HOME/.local/share/omablue/bin"

set -euo pipefail

# --- Dipendenze ---
if ! command -v gum &> /dev/null; then
    notify-send "Errore" "Installa 'gum' per usare questo script."
    exit 1
fi
if ! command -v jq &> /dev/null; then
    notify-send "Errore" "Installa 'jq' per rilevare i profili del browser."
    exit 1
fi

# Creazione cartelle necessarie
mkdir -p "$HOME/.local/share/applications/icons"

# --- 1. Raccolta Input ---
if [ "$#" -lt 3 ]; then
    echo -e "\e[34m󰖟 Omablue WebApp Installer\e[0m\n"

    APP_NAME=$(gum input --prompt "Nome App > " --placeholder "Es: WhatsApp")
    [[ -z "$APP_NAME" ]] && exit 0

    APP_URL=$(gum input --prompt "URL > " --placeholder "https://web.whatsapp.com")
    [[ -z "$APP_URL" ]] && exit 0

    ICON_REF=$(gum input --prompt "URL Icona > " --placeholder "https://... (o path locale)")
    [[ -z "$ICON_REF" ]] && exit 0

    INTERACTIVE_MODE=true
else
    APP_NAME="$1"
    APP_URL="$2"
    ICON_REF="$3"
    INTERACTIVE_MODE=false
fi

# --- 2. Rilevamento Browser ---
declare -A BROWSER_BINARIES=(
    [Brave]=brave 
    [Google Chrome]=google-chrome-stable 
    [Chromium]=chromium
    [Microsoft Edge]=microsoft-edge-stable 
    [Vivaldi]=vivaldi 
    [Helium]=helium-browser
    [Trivalent]=trivalent
)

BROWSERS=()
for name in "${!BROWSER_BINARIES[@]}"; do
    if command -v "${BROWSER_BINARIES[$name]}" >/dev/null 2>&1; then
        BROWSERS+=("$name")
    fi
done

if [ ${#BROWSERS[@]} -eq 0 ]; then
    gum style --foreground 196 "Nessun browser supportato trovato."
    exit 1
fi

BROWSER_CHOICE=$(gum choose --header "Quale browser vuoi usare?" "${BROWSERS[@]}")
BROWSER_BIN="${BROWSER_BINARIES[$BROWSER_CHOICE]}"

# --- 3. Gestione Profili Avanzata ---
declare -A BROWSER_CONFIG_DIRS=(
    [Chromium]="$HOME/.config/chromium"
    [Google Chrome]="$HOME/.config/google-chrome"
    [Brave]="$HOME/.config/BraveSoftware/Brave-Browser"
    [Microsoft Edge]="$HOME/.config/microsoft-edge"
    [Vivaldi]="$HOME/.config/vivaldi"
    [Helium]="$HOME/.config/net.imput.helium"
    [Trivalent]="$HOME/.config/trivalent"
)

PROFILE_DIR="${BROWSER_CONFIG_DIRS[$BROWSER_CHOICE]:-$HOME/.config/$BROWSER_CHOICE}"
APP_PROFILE_FOLDER="Default" # Fallback

if [ -f "$PROFILE_DIR/Local State" ]; then
    # Metodo JSON (Chromium standard) - Richiede jq
    declare -A PROFILE_MAP
    PROFILES=()
    
    # Leggiamo i nomi dei profili (es. "Personale", "Lavoro") e le cartelle (es. "Profile 1")
    while IFS='|' read -r folder name; do
        if [[ -n "$name" ]]; then
            PROFILES+=("$name")
            PROFILE_MAP["$name"]="$folder"
        fi
    done < <(jq -r '.profile.info_cache | to_entries[] | "\(.key)|\(.value.name)"' "$PROFILE_DIR/Local State" 2>/dev/null || true)

    if [ ${#PROFILES[@]} -gt 1 ]; then
        CHOSEN_PROFILE=$(gum choose --header "Seleziona Profilo Browser" "${PROFILES[@]}")
        APP_PROFILE_FOLDER="${PROFILE_MAP[$CHOSEN_PROFILE]}"
    elif [ ${#PROFILES[@]} -eq 1 ]; then
        APP_PROFILE_FOLDER="${PROFILE_MAP[${PROFILES[0]}]}"
    fi

elif [ -d "$PROFILE_DIR" ]; then
    # Fallback scansione cartelle se Local State non esiste o è illeggibile
    PROFILES=()
    for d in "$PROFILE_DIR"/Profile*; do
        [[ -d "$d" ]] || continue
        PROFILES+=("$(basename "$d")")
    done
    
    if [ ${#PROFILES[@]} -gt 0 ]; then
        APP_PROFILE_FOLDER=$(gum choose --header "Seleziona Cartella Profilo" "${PROFILES[@]}")
    fi
fi

# --- 4. Gestione Icona ---
ICON_DEST="$HOME/.local/share/applications/icons/$APP_NAME.png"

if [[ $ICON_REF =~ ^https?:// ]]; then
    # Scarica icona se è un URL
    if ! curl -sL -o "$ICON_DEST" "$ICON_REF"; then
        ICON_DEST="web-browser" # Fallback icona di sistema
    fi
elif [[ -f "$ICON_REF" ]]; then
    # Copia se è un file locale
    cp "$ICON_REF" "$ICON_DEST"
else
    # Usa stringa come nome icona di sistema
    ICON_DEST="$ICON_REF"
fi

# --- 5. Creazione File Desktop ---
LAUNCHER_SCRIPT="$OMABIN/omablue-launch-webapp"
DESKTOP_FILE="$HOME/.local/share/applications/$APP_NAME.desktop"

# Pulizia: Assicuriamoci che il nome del launcher sia corretto
if [[ ! -f "$LAUNCHER_SCRIPT" ]]; then
    echo "ATTENZIONE: Launcher non trovato in $LAUNCHER_SCRIPT"
fi

cat >"$DESKTOP_FILE" <<EOF
[Desktop Entry]
Version=1.0
Name=$APP_NAME
Comment=Web App Omablue
Exec=$LAUNCHER_SCRIPT '$APP_URL' '$APP_PROFILE_FOLDER' '$BROWSER_BIN'
Terminal=false
Type=Application
Icon=$ICON_DEST
StartupNotify=true
Categories=Network;WebBrowser;
EOF

chmod +x "$DESKTOP_FILE"

# --- 6. Feedback ---
if [[ $INTERACTIVE_MODE == true ]]; then
    notify-send "Omablue" "WebApp installata: $APP_NAME ($BROWSER_CHOICE)"
    echo -e "\n\e[32m✔ Installazione completata!\e[0m"
    sleep 1
fi#!/bin/bash
# 1. Forza il titolo della finestra per le regole di Sway (Floating Center)
echo -ne "\033]0;omablue-webapp-install\007"

# 2. PATH Setup Robusto (per trovare gum e jq ovunque)
export PATH="$HOME/.local/share/omablue/bin:$HOME/.local/bin:/usr/local/bin:/usr/bin:/bin:$PATH"
OMABIN="$HOME/.local/share/omablue/bin"

set -euo pipefail

# --- Dipendenze ---
if ! command -v gum &> /dev/null; then
    notify-send "Errore" "Installa 'gum' per usare questo script."
    exit 1
fi
if ! command -v jq &> /dev/null; then
    notify-send "Errore" "Installa 'jq' per rilevare i profili del browser."
    exit 1
fi

# Creazione cartelle necessarie
mkdir -p "$HOME/.local/share/applications/icons"

# --- 1. Raccolta Input ---
if [ "$#" -lt 3 ]; then
    echo -e "\e[34m󰖟 Omablue WebApp Installer\e[0m\n"

    APP_NAME=$(gum input --prompt "Nome App > " --placeholder "Es: WhatsApp")
    [[ -z "$APP_NAME" ]] && exit 0

    APP_URL=$(gum input --prompt "URL > " --placeholder "https://web.whatsapp.com")
    [[ -z "$APP_URL" ]] && exit 0

    ICON_REF=$(gum input --prompt "URL Icona > " --placeholder "https://... (o path locale)")
    [[ -z "$ICON_REF" ]] && exit 0

    INTERACTIVE_MODE=true
else
    APP_NAME="$1"
    APP_URL="$2"
    ICON_REF="$3"
    INTERACTIVE_MODE=false
fi

# --- 2. Rilevamento Browser ---
declare -A BROWSER_BINARIES=(
    [Brave]=brave 
    [Google Chrome]=google-chrome-stable 
    [Chromium]=chromium
    [Microsoft Edge]=microsoft-edge-stable 
    [Vivaldi]=vivaldi 
    [Helium]=helium-browser
    [Trivalent]=trivalent
)

BROWSERS=()
for name in "${!BROWSER_BINARIES[@]}"; do
    if command -v "${BROWSER_BINARIES[$name]}" >/dev/null 2>&1; then
        BROWSERS+=("$name")
    fi
done

if [ ${#BROWSERS[@]} -eq 0 ]; then
    gum style --foreground 196 "Nessun browser supportato trovato."
    exit 1
fi

BROWSER_CHOICE=$(gum choose --header "Quale browser vuoi usare?" "${BROWSERS[@]}")
BROWSER_BIN="${BROWSER_BINARIES[$BROWSER_CHOICE]}"

# --- 3. Gestione Profili Avanzata ---
declare -A BROWSER_CONFIG_DIRS=(
    [Chromium]="$HOME/.config/chromium"
    [Google Chrome]="$HOME/.config/google-chrome"
    [Brave]="$HOME/.config/BraveSoftware/Brave-Browser"
    [Microsoft Edge]="$HOME/.config/microsoft-edge"
    [Vivaldi]="$HOME/.config/vivaldi"
    [Helium]="$HOME/.config/net.imput.helium"
    [Trivalent]="$HOME/.config/trivalent"
)

PROFILE_DIR="${BROWSER_CONFIG_DIRS[$BROWSER_CHOICE]:-$HOME/.config/$BROWSER_CHOICE}"
APP_PROFILE_FOLDER="Default" # Fallback

if [ -f "$PROFILE_DIR/Local State" ]; then
    # Metodo JSON (Chromium standard) - Richiede jq
    declare -A PROFILE_MAP
    PROFILES=()
    
    # Leggiamo i nomi dei profili (es. "Personale", "Lavoro") e le cartelle (es. "Profile 1")
    while IFS='|' read -r folder name; do
        if [[ -n "$name" ]]; then
            PROFILES+=("$name")
            PROFILE_MAP["$name"]="$folder"
        fi
    done < <(jq -r '.profile.info_cache | to_entries[] | "\(.key)|\(.value.name)"' "$PROFILE_DIR/Local State" 2>/dev/null || true)

    if [ ${#PROFILES[@]} -gt 1 ]; then
        CHOSEN_PROFILE=$(gum choose --header "Seleziona Profilo Browser" "${PROFILES[@]}")
        APP_PROFILE_FOLDER="${PROFILE_MAP[$CHOSEN_PROFILE]}"
    elif [ ${#PROFILES[@]} -eq 1 ]; then
        APP_PROFILE_FOLDER="${PROFILE_MAP[${PROFILES[0]}]}"
    fi

elif [ -d "$PROFILE_DIR" ]; then
    # Fallback scansione cartelle se Local State non esiste o è illeggibile
    PROFILES=()
    for d in "$PROFILE_DIR"/Profile*; do
        [[ -d "$d" ]] || continue
        PROFILES+=("$(basename "$d")")
    done
    
    if [ ${#PROFILES[@]} -gt 0 ]; then
        APP_PROFILE_FOLDER=$(gum choose --header "Seleziona Cartella Profilo" "${PROFILES[@]}")
    fi
fi

# --- 4. Gestione Icona ---
ICON_DEST="$HOME/.local/share/applications/icons/$APP_NAME.png"

if [[ $ICON_REF =~ ^https?:// ]]; then
    # Scarica icona se è un URL
    if ! curl -sL -o "$ICON_DEST" "$ICON_REF"; then
        ICON_DEST="web-browser" # Fallback icona di sistema
    fi
elif [[ -f "$ICON_REF" ]]; then
    # Copia se è un file locale
    cp "$ICON_REF" "$ICON_DEST"
else
    # Usa stringa come nome icona di sistema
    ICON_DEST="$ICON_REF"
fi

# --- 5. Creazione File Desktop ---
LAUNCHER_SCRIPT="$OMABIN/omablue-launch-webapp"
DESKTOP_FILE="$HOME/.local/share/applications/$APP_NAME.desktop"

# Pulizia: Assicuriamoci che il nome del launcher sia corretto
if [[ ! -f "$LAUNCHER_SCRIPT" ]]; then
    echo "ATTENZIONE: Launcher non trovato in $LAUNCHER_SCRIPT"
fi

cat >"$DESKTOP_FILE" <<EOF
[Desktop Entry]
Version=1.0
Name=$APP_NAME
Comment=Web App Omablue
Exec=$LAUNCHER_SCRIPT '$APP_URL' '$APP_PROFILE_FOLDER' '$BROWSER_BIN'
Terminal=false
Type=Application
Icon=$ICON_DEST
StartupNotify=true
Categories=Network;WebBrowser;
EOF

chmod +x "$DESKTOP_FILE"

# --- 6. Feedback ---
if [[ $INTERACTIVE_MODE == true ]]; then
    notify-send "Omablue" "WebApp installata: $APP_NAME ($BROWSER_CHOICE)"
    echo -e "\n\e[32m✔ Installazione completata!\e[0m"
    sleep 1
fi#!/bin/bash
# 1. Forza il titolo della finestra per le regole di Sway (Floating Center)
echo -ne "\033]0;omablue-webapp-install\007"

# 2. PATH Setup Robusto (per trovare gum e jq ovunque)
export PATH="$HOME/.local/share/omablue/bin:$HOME/.local/bin:/usr/local/bin:/usr/bin:/bin:$PATH"
OMABIN="$HOME/.local/share/omablue/bin"

set -euo pipefail

# --- Dipendenze ---
if ! command -v gum &> /dev/null; then
    notify-send "Errore" "Installa 'gum' per usare questo script."
    exit 1
fi
if ! command -v jq &> /dev/null; then
    notify-send "Errore" "Installa 'jq' per rilevare i profili del browser."
    exit 1
fi

# Creazione cartelle necessarie
mkdir -p "$HOME/.local/share/applications/icons"

# --- 1. Raccolta Input ---
if [ "$#" -lt 3 ]; then
    echo -e "\e[34m󰖟 Omablue WebApp Installer\e[0m\n"

    APP_NAME=$(gum input --prompt "Nome App > " --placeholder "Es: WhatsApp")
    [[ -z "$APP_NAME" ]] && exit 0

    APP_URL=$(gum input --prompt "URL > " --placeholder "https://web.whatsapp.com")
    [[ -z "$APP_URL" ]] && exit 0

    ICON_REF=$(gum input --prompt "URL Icona > " --placeholder "https://... (o path locale)")
    [[ -z "$ICON_REF" ]] && exit 0

    INTERACTIVE_MODE=true
else
    APP_NAME="$1"
    APP_URL="$2"
    ICON_REF="$3"
    INTERACTIVE_MODE=false
fi

# --- 2. Rilevamento Browser ---
declare -A BROWSER_BINARIES=( 
    [Trivalent]=trivalent
)

BROWSERS=()
for name in "${!BROWSER_BINARIES[@]}"; do
    if command -v "${BROWSER_BINARIES[$name]}" >/dev/null 2>&1; then
        BROWSERS+=("$name")
    fi
done

if [ ${#BROWSERS[@]} -eq 0 ]; then
    gum style --foreground 196 "Nessun browser supportato trovato."
    exit 1
fi

BROWSER_CHOICE=$(gum choose --header "Quale browser vuoi usare?" "${BROWSERS[@]}")
BROWSER_BIN="${BROWSER_BINARIES[$BROWSER_CHOICE]}"

# --- 3. Gestione Profili Avanzata ---
declare -A BROWSER_CONFIG_DIRS=( 
    [Trivalent]="$HOME/.config/trivalent"
)

PROFILE_DIR="${BROWSER_CONFIG_DIRS[$BROWSER_CHOICE]:-$HOME/.config/$BROWSER_CHOICE}"
APP_PROFILE_FOLDER="Default" # Fallback

if [ -f "$PROFILE_DIR/Local State" ]; then
    # Metodo JSON (Chromium standard) - Richiede jq
    declare -A PROFILE_MAP
    PROFILES=()
    
    # Leggiamo i nomi dei profili (es. "Personale", "Lavoro") e le cartelle (es. "Profile 1")
    while IFS='|' read -r folder name; do
        if [[ -n "$name" ]]; then
            PROFILES+=("$name")
            PROFILE_MAP["$name"]="$folder"
        fi
    done < <(jq -r '.profile.info_cache | to_entries[] | "\(.key)|\(.value.name)"' "$PROFILE_DIR/Local State" 2>/dev/null || true)

    if [ ${#PROFILES[@]} -gt 1 ]; then
        CHOSEN_PROFILE=$(gum choose --header "Seleziona Profilo Browser" "${PROFILES[@]}")
        APP_PROFILE_FOLDER="${PROFILE_MAP[$CHOSEN_PROFILE]}"
    elif [ ${#PROFILES[@]} -eq 1 ]; then
        APP_PROFILE_FOLDER="${PROFILE_MAP[${PROFILES[0]}]}"
    fi

elif [ -d "$PROFILE_DIR" ]; then
    # Fallback scansione cartelle se Local State non esiste o è illeggibile
    PROFILES=()
    for d in "$PROFILE_DIR"/Profile*; do
        [[ -d "$d" ]] || continue
        PROFILES+=("$(basename "$d")")
    done
    
    if [ ${#PROFILES[@]} -gt 0 ]; then
        APP_PROFILE_FOLDER=$(gum choose --header "Seleziona Cartella Profilo" "${PROFILES[@]}")
    fi
fi

# --- 4. Gestione Icona ---
ICON_DEST="$HOME/.local/share/applications/icons/$APP_NAME.png"

if [[ $ICON_REF =~ ^https?:// ]]; then
    # Scarica icona se è un URL
    if ! curl -sL -o "$ICON_DEST" "$ICON_REF"; then
        ICON_DEST="web-browser" # Fallback icona di sistema
    fi
elif [[ -f "$ICON_REF" ]]; then
    # Copia se è un file locale
    cp "$ICON_REF" "$ICON_DEST"
else
    # Usa stringa come nome icona di sistema
    ICON_DEST="$ICON_REF"
fi

# --- 5. Creazione File Desktop ---
LAUNCHER_SCRIPT="$OMABIN/omablue-launch-webapp"
DESKTOP_FILE="$HOME/.local/share/applications/$APP_NAME.desktop"

# Pulizia: Assicuriamoci che il nome del launcher sia corretto
if [[ ! -f "$LAUNCHER_SCRIPT" ]]; then
    echo "ATTENZIONE: Launcher non trovato in $LAUNCHER_SCRIPT"
fi

cat >"$DESKTOP_FILE" <<EOF
[Desktop Entry]
Version=1.0
Name=$APP_NAME
Comment=Web App Omablue
Exec=$LAUNCHER_SCRIPT '$APP_URL' '$APP_PROFILE_FOLDER' '$BROWSER_BIN'
Terminal=false
Type=Application
Icon=$ICON_DEST
StartupNotify=true
Categories=Network;WebBrowser;
EOF

chmod +x "$DESKTOP_FILE"

# --- 6. Feedback ---
if [[ $INTERACTIVE_MODE == true ]]; then
    notify-send "Omablue" "WebApp installata: $APP_NAME ($BROWSER_CHOICE)"
    echo -e "\n\e[32m✔ Installazione completata!\e[0m"
    sleep 1
fi
